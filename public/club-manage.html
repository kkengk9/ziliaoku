<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç¤¾åœ˜ç®¡ç†</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { padding: 2rem; max-width: 900px; margin: auto; }
    .section { margin-top: 2.5rem; }
    .section h4 { border-bottom: 2px solid #dee2e6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; }
    .btn + .btn { margin-left: 0.5rem; }
    .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 10000; }
  </style>
</head>
<body>
  <h2 class="mb-4 text-primary">ğŸ“‹ ç¤¾åœ˜ç®¡ç†ä»‹é¢</h2>

  <div class="section">
    <label class="form-label">é¸æ“‡ä½ çš„ç¤¾åœ˜ï¼š</label>
    <select id="clubSelect" class="form-select"></select>
  </div>

  <div class="section">
    <h4>ğŸ‘¥ ç”³è«‹åå–®å¯©æ ¸</h4>
    <ul id="applicantsList" class="list-group"></ul>
  </div>

  <div class="section row">
    <div class="col-md-6">
      <h4>ğŸ‘‘ è½‰è®“ç¤¾é•·è·ä½</h4>
      <select id="transferPresidentSelect" class="form-select mb-2"></select>
      <button class="btn btn-warning w-100" onclick="transferPresident()">è½‰è®“ç¤¾é•·</button>
    </div>
    <div class="col-md-6">
      <h4>ğŸ–ï¸ è½‰è®“å¹¹éƒ¨è·ä½</h4>
      <select id="transferOfficerSelect" class="form-select mb-2"></select>
      <button class="btn btn-secondary w-100" onclick="transferOfficer()">è½‰è®“å¹¹éƒ¨</button>
    </div>
  </div>

  <div class="section">
    <h4 class="text-danger">âŒ åˆªé™¤æ•´å€‹ç¤¾åœ˜</h4>
    <button class="btn btn-outline-danger w-100" onclick="deleteClub()">âš ï¸ åˆªé™¤ç¤¾åœ˜èˆ‡èŠå¤©å®¤</button>
  </div>

  <div class="toast-container position-fixed top-0 end-0 p-3" id="toastArea"></div>

  <script>
    const token = localStorage.getItem('token');

    function showToast(message, success = true) {
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white ${success ? 'bg-success' : 'bg-danger'} border-0 show`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>`;
      document.getElementById('toastArea').appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    async function loadClubs() {
      const res = await fetch('/my-clubs', {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      const select = document.getElementById('clubSelect');
      select.innerHTML = '';
      data.filter(c => c.role === 'president').forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        select.appendChild(opt);
      });
      if (select.value) {
        loadApplicants(select.value);
        loadMembers(select.value);
      }
    }

    async function loadApplicants(club_id) {
      const res = await fetch(`/club-applicants/${club_id}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const list = document.getElementById('applicantsList');
      const data = await res.json();
      list.innerHTML = '';
      if (data.length === 0) {
        list.innerHTML = `<li class="list-group-item text-muted">ç›®å‰ç„¡å¾…å¯©æ ¸ç”³è«‹</li>`;
      } else {
        data.forEach(u => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.innerHTML = `<span>${u.name} (${u.username})</span>
            <button class="btn btn-sm btn-success" onclick="approve(${club_id}, ${u.id})">æ ¸å‡†</button>`;
          list.appendChild(li);
        });
      }
    }

    async function approve(club_id, user_id) {
      const res = await fetch('/approve-member', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ club_id, user_id })
      });
      showToast(await res.text(), res.ok);
      loadApplicants(club_id);
      loadMembers(club_id);
    }

    async function loadMembers(club_id) {
  const res = await fetch(`/club-members/${club_id}`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const data = await res.json();
  const presSel = document.getElementById('transferPresidentSelect');
  const offSel = document.getElementById('transferOfficerSelect');
  presSel.innerHTML = '';
  offSel.innerHTML = '';
  data.forEach(m => {
    const opt1 = document.createElement('option');
    opt1.value = m.id;
    opt1.textContent = `${m.name} (${m.username}) - ${m.role}`;
    const opt2 = opt1.cloneNode(true);
    presSel.appendChild(opt1);
    offSel.appendChild(opt2);
  });
}


    async function transferPresident() {
      const club_id = document.getElementById('clubSelect').value;
      const user_id = document.getElementById('transferPresidentSelect').value;
      const res = await fetch('/clubs/transfer-president', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ club_id, target_user_id: user_id })
      });
      showToast(await res.text(), res.ok);
    }

    async function transferOfficer() {
      const club_id = document.getElementById('clubSelect').value;
      const user_id = document.getElementById('transferOfficerSelect').value;
      const res = await fetch('/clubs/transfer-officer', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ club_id, target_user_id: user_id })
      });
      showToast(await res.text(), res.ok);
    }

    async function deleteClub() {
      const club_id = document.getElementById('clubSelect').value;
      if (!confirm('âš ï¸ ä½ ç¢ºå®šè¦åˆªé™¤é€™å€‹ç¤¾åœ˜èˆ‡æ‰€æœ‰è¨Šæ¯å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼')) return;
      const res = await fetch(`/clubs/${club_id}`, {
        method: 'DELETE',
        headers: { Authorization: `Bearer ${token}` }
      });
      showToast(await res.text(), res.ok);
      loadClubs();
    }

    document.getElementById('clubSelect').addEventListener('change', (e) => {
      loadApplicants(e.target.value);
      loadMembers(e.target.value);
    });

    loadClubs();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>